<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web GIS Portal - 2D Only</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #333;
      --panel-bg: #fff;
      --panel-text: #333;
      --border-color: #ccc;
      --hover-bg: #f0f0f0;
      --topbar-bg: #2c3e50;
      --topbar-text: white;
      --submenu-bg: #34495e;
      --subtab-bg: #2c3e50;
      --subtab-text: white;
      --subtab-hover: #3e5c76;
      --divider-color: #ecf0f1;
      --status-bg: rgba(255, 255, 255, 0.95);
      --status-text: #333;
      --footer-bg: #f8f8f8;
      --footer-text: #666;
      --link-color: #2c3e50;
      --tooltip-bg: #2c3e50;
      --popup-bg: rgba(255, 255, 255, 0.95);
      --popup-text: #333;
      --attribute-bg: #f5f5f5;
      --search-bg: white;
      --select-bg: #34495e;
      --select-text: white;
      --select-border: #ecf0f1;
    }
    .dark-theme {
      --bg-color: #1a1a1a;
      --text-color: #fff;
      --panel-bg: #2c2c2c;
      --panel-text: #ddd;
      --border-color: #555;
      --hover-bg: #404040;
      --topbar-bg: #1a1a1a;
      --topbar-text: #fff;
      --submenu-bg: #2c2c2c;
      --subtab-bg: #404040;
      --subtab-text: #fff;
      --subtab-hover: #555;
      --divider-color: #555;
      --status-bg: rgba(44, 44, 44, 0.95);
      --status-text: #fff;
      --footer-bg: #2c2c2c;
      --footer-text: #aaa;
      --link-color: #ecf0f1;
      --tooltip-bg: #404040;
      --popup-bg: rgba(44, 44, 44, 0.95);
      --popup-text: #fff;
      --attribute-bg: #404040;
      --search-bg: #2c2c2c;
      --select-bg: #555;
      --select-text: #fff;
      --select-border: #777;
    }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    /* Top navigation bar */
    #topbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 45px;
      background-color: var(--topbar-bg);
      display: flex;
      align-items: center;
      padding-left: 20px;
      z-index: 1000;
    }
    #topbar .tab {
      color: var(--topbar-text);
      margin-right: 25px;
      cursor: pointer;
      font-size: 14px;
      padding: 10px 5px;
      border-bottom: 2px solid transparent;
      transition: border-bottom 0.2s;
    }
    #topbar .tab:hover {
      border-bottom: 2px solid var(--divider-color);
    }
    #topbar .tab.active {
      border-bottom: 2px solid #e74c3c;
    }

    /* Submenu panel style */
    .submenu-panel {
      position: fixed;
      top: 45px;
      left: 0;
      width: 100%;
      height: 40px;
      background-color: var(--submenu-bg);
      display: none;
      align-items: center;
      padding: 0 20px;
      z-index: 999;
      transition: all 0.3s ease;
    }
    .submenu-panel.show {
      display: flex;
    }
    .submenu-panel .subtab {
      background-color: var(--subtab-bg);
      color: var(--subtab-text);
      padding: 6px 12px;
      margin-right: 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s, transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .submenu-panel .subtab:hover {
      background-color: var(--subtab-hover);
      transform: scale(1.05);
    }
    .submenu-panel .subtab i {
      margin-right: 5px;
      font-size: 12px;
    }

    /* Settings submenu */
    #settingsSubmenu {
      position: fixed;
      top: 45px;
      left: 0;
      width: 100%;
      height: 40px;
      background-color: var(--submenu-bg);
      display: none;
      align-items: center;
      padding: 0 20px;
      z-index: 999;
      transition: all 0.3s ease;
    }
    #settingsSubmenu.show {
      display: flex;
    }
    #settingsSubmenu .panel {
      flex: 1;
      background-color: var(--subtab-bg);
      padding: 5px 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      height: 30px;
      display: flex;
      align-items: center;
    }
    #settingsSubmenu .left-panel {
      margin-right: 10px;
    }
    #settingsSubmenu .right-panel {
      margin-left: 10px;
    }
    #settingsSubmenu .divider {
      width: 1px;
      height: 30px;
      background-color: var(--divider-color);
      margin: 0 10px;
    }
    #settingsSubmenu label {
      color: var(--subtab-text);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #settingsSubmenu input[type="checkbox"] {
      cursor: pointer;
      transform: scale(1.0);
    }
    #settingsSubmenu select {
      background: var(--select-bg);
      color: var(--select-text);
      border: 1px solid var(--select-border);
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
      width: 100px;
      height: 20px;
    }
    #settingsSubmenu select:hover {
      background: var(--subtab-hover);
    }

    /* Layer panel */
    #layerPanel {
      position: fixed;
      top: 85px;
      bottom: 10px;
      left: 10px;
      width: 280px;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0;
      z-index: 1000;
      transition: transform 0.3s ease;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
    }
    #layerPanel.collapsed {
      transform: translateX(-100%);
    }
    #layerPanel .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--topbar-bg);
      color: var(--topbar-text);
      padding: 10px 15px;
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
    }
    #layerPanel .panel-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: bold;
    }
    #layerPanel .close-btn {
      cursor: pointer;
      font-size: 16px;
      padding: 3px 8px;
      background: #e74c3c;
      color: white;
      border-radius: 4px;
      transition: background 0.2s;
    }
    #layerPanel .close-btn:hover {
      background: #c0392b;
    }
    .search-container {
      position: relative;
      margin: 10px 15px;
    }
    .search-bar {
      padding: 6px 30px 6px 8px;
      width: 100%;
      font-size: 13px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
      background-color: var(--search-bg);
      color: var(--text-color);
    }
    .search-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      color: var(--text-color);
    }
    .search-btn:hover {
      color: var(--link-color);
    }
    #searchResults {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: var(--search-bg);
      border: 1px solid var(--border-color);
      border-radius: 0 0 4px 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1001;
      display: none;
      box-sizing: border-box;
      color: var(--text-color);
    }
    #searchResults .result-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
    }
    #searchResults .result-item:hover {
      background: var(--hover-bg);
    }
    #layerPanel .layer-list {
      flex-grow: 1;
      overflow-y: auto;
      padding: 0 10px 10px 10px;
    }
    #layerPanel .layer-footer {
      flex-shrink: 0;
      padding: 10px 15px;
      background: var(--footer-bg);
      border-top: 1px solid var(--border-color);
      text-align: center;
      font-size: 12px;
      color: var(--footer-text);
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
    }
    #layerPanel .layer-footer a {
      color: var(--link-color);
      text-decoration: none;
      font-weight: bold;
    }
    #layerPanel .layer-footer a:hover {
      text-decoration: underline;
    }
    #layerPanel .layer-group {
      margin-bottom: 15px;
    }
    #layerPanel .layer-group h4 {
      font-size: 13px;
      color: var(--link-color);
      margin: 10px 0 5px 5px;
      padding-bottom: 3px;
      font-weight: bold;
      border-bottom: 1px solid var(--border-color);
    }
    #layerPanel .layer-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 4px 5px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    #layerPanel .layer-item:hover {
      background: var(--hover-bg);
    }
    #layerPanel .layer-item input[type="checkbox"] {
      margin-right: 8px;
    }
    #layerPanel .layer-item label {
      font-size: 14px;
      flex-grow: 1;
      cursor: pointer;
      user-select: none;
      color: var(--panel-text);
    }

    /* Dropdowns */
    #featureDropdown, #rasterDropdown, #objectDropdown, #baseLayerDropdown {
      background-color: var(--submenu-bg);
      padding: 5px 0;
      position: absolute;
      display: none;
      flex-direction: column;
      z-index: 2000;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #featureDropdown .subtab, #rasterDropdown .subtab, #objectDropdown .subtab, #baseLayerDropdown .subtab {
      background-color: var(--subtab-bg);
      color: var(--subtab-text);
      padding: 6px 12px;
      margin: 3px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s, transform 0.2s;
      position: relative;
    }
    #featureDropdown .subtab:hover, #rasterDropdown .subtab:hover, #objectDropdown .subtab:hover, #baseLayerDropdown .subtab:hover {
      background-color: var(--subtab-hover);
      transform: scale(1.05);
    }
    #featureDropdown .subtab i, #rasterDropdown .subtab i, #objectDropdown .subtab i, #baseLayerDropdown .subtab i {
      margin-right: 5px;
      font-size: 12px;
    }

    /* Context menu */
    #contextMenu {
      position: absolute;
      background-color: var(--submenu-bg);
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 2000;
      display: none;
      flex-direction: column;
      padding: 2px 0;
    }
    #contextMenu .menu-item {
      color: var(--subtab-text);
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }
    #contextMenu .menu-item:hover {
      background-color: var(--subtab-bg);
    }

    /* Map container */
    #map-container {
      width: 100%;
      height: calc(100% - 45px);
      position: absolute;
      top: 45px;
      display: flex;
      transition: opacity 0.5s ease;
    }
    #map-left, #map-right {
      width: 100%;
      height: 100%;
      position: relative;
    }
    #map-left {
      display: none;
    }
    #map-right {
      display: block;
    }
    .dual-map #map-left, .dual-map #map-right {
      width: 50%;
      display: block;
    }
    .dual-map #map-left {
      border-right: 2px solid var(--submenu-bg);
    }

    /* Base layer popups */
    #baseLayerPopupLeft, #baseLayerPopupRight {
      position: absolute;
      top: 10px;
      background: var(--submenu-bg);
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1001;
      display: none;
    }
    #baseLayerPopupLeft select, #baseLayerPopupRight select {
      background: var(--subtab-bg);
      color: var(--subtab-text);
      border: 1px solid var(--select-border);
      padding: 4px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      width: 150px;
    }
    #baseLayerPopupLeft select:hover, #baseLayerPopupRight select:hover {
      background: var(--subtab-hover);
    }
    #baseLayerPopupLeft {
      left: 50%;
      transform: translateX(-50%);
    }
    #baseLayerPopupRight {
      right: 50%;
      transform: translateX(50%);
    }

    /* Attribute table popup */
    .attribute-table {
      position: absolute;
      background: var(--popup-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      font-size: 12px;
      max-width: 200px;
      color: var(--popup-text);
    }
    .attribute-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .attribute-table td {
      padding: 5px;
      border: 1px solid var(--border-color);
    }
    .attribute-table td:first-child {
      font-weight: bold;
      background: var(--attribute-bg);
    }
    .attribute-table .close-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      cursor: pointer;
      font-size: 12px;
      padding: 1px 4px;
      background: #e74c3c;
      color: white;
      border-radius: 3px;
    }
    .attribute-table .close-btn:hover {
      background: #c0392b;
    }

    /* Feature popup */
    .feature-popup {
      position: absolute;
      background: var(--popup-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 1002;
      font-size: 13px;
      width: 220px;
      color: var(--popup-text);
    }
    .feature-popup .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      font-size: 14px;
      padding: 2px 6px;
      background: #e74c3c;
      color: white;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .feature-popup .close-btn:hover {
      background: #c0392b;
    }
    .feature-popup label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .feature-popup input, .feature-popup select {
      width: 100%;
      padding: 4px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 12px;
      background-color: var(--panel-bg);
      color: var(--panel-text);
    }
    .feature-popup input[type="color"] {
      height: 30px;
      padding: 2px;
      cursor: pointer;
    }
    .feature-popup button {
      width: 100%;
      padding: 6px;
      background: var(--topbar-bg);
      color: var(--topbar-text);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .feature-popup button:hover {
      background: var(--submenu-bg);
    }

    /* Audit Popup */
    #auditPopup {
      position: fixed;
      top: 100px;
      right: 20px;
      width: 320px;
      height: 400px;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0;
      z-index: 1003;
      box-shadow: -2px 2px 8px rgba(0, 0, 0, 0.25);
      display: none;
      flex-direction: column;
      color: var(--panel-text);
    }
    #auditPopup .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--topbar-bg);
      color: var(--topbar-text);
      padding: 10px 15px;
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
    }
    #auditPopup .popup-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: bold;
    }
    #auditPopup .close-btn {
      cursor: pointer;
      font-size: 16px;
      padding: 3px 8px;
      background: #e74c3c;
      color: white;
      border-radius: 4px;
      transition: background 0.2s;
    }
    #auditPopup .close-btn:hover {
      background: #c0392b;
    }
    #auditPopup .log-list {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      font-size: 12px;
    }
    .log-item {
      padding: 5px;
      border-bottom: 1px solid var(--border-color);
      color: var(--footer-text);
      margin-bottom: 5px;
    }
    #auditPopup .layer-footer {
      flex-shrink: 0;
      padding: 10px 15px;
      background: var(--footer-bg);
      border-top: 1px solid var(--border-color);
      text-align: center;
      font-size: 12px;
      color: var(--footer-text);
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #auditPopup .layer-footer button {
      padding: 5px 10px;
      background: var(--topbar-bg);
      color: var(--topbar-text);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    #auditPopup .layer-footer button:hover {
      background: var(--submenu-bg);
    }

    /* Zoom controls */
    .ol-zoom {
      top: 50% !important;
      left: auto !important;
      right: 10px !important;
      transform: translateY(-50%);
      background: none !important;
    }
    .ol-zoom-in, .ol-zoom-out {
      background: var(--topbar-bg) !important;
      color: white !important;
      border-radius: 50% !important;
      width: 40px !important;
      height: 40px !important;
      line-height: 40px !important;
      font-size: 24px !important;
      margin-bottom: 8px !important;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s, background 0.2s;
    }
    .ol-zoom-in:hover, .ol-zoom-out:hover {
      background: var(--submenu-bg) !important;
      transform: scale(1.1);
    }
    .dual-map .ol-zoom {
      right: 5px !important;
    }

    /* North button */
    .ol-north {
      position: absolute;
      right: 10px;
      top: calc(50% - 100px);
      background: var(--topbar-bg);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      line-height: 40px;
      cursor: pointer;
      font-size: 20px;
      z-index: 1000;
      text-align: center;
      transform-origin: center;
      transition: transform 0.1s linear, background 0.2s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .dual-map .ol-north {
      right: 5px !important;
    }
    .ol-north:hover {
      background: var(--submenu-bg);
      transform: scale(1.1);
    }

    /* Status bar */
    #statusbar {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: var(--status-bg);
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      white-space: nowrap;
      color: var(--status-text);
    }
    #coords {
      margin: 0;
    }
    #goto input {
      width: 70px;
      padding: 2px;
      font-size: 12px;
      background-color: var(--panel-bg);
      color: var(--panel-text);
      border: 1px solid var(--border-color);
    }
    #goto button {
      padding: 3px 8px;
      font-size: 12px;
      cursor: pointer;
      background: var(--topbar-bg);
      color: var(--topbar-text);
      border: none;
      border-radius: 4px;
    }
    #goto button:hover {
      background: var(--submenu-bg);
    }
    #epsgContainer {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #epsgInput {
      position: absolute;
      top: -35px;
      right: 0;
      padding: 4px 6px;
      font-size: 13px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: none;
      background: var(--panel-bg);
      color: var(--panel-text);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 1100;
    }
    #epsgLabel {
      cursor: pointer;
      font-weight: bold;
      color: var(--link-color);
    }
  </style>
</head>
<body>
  <!-- Top navigation bar -->
  <div id="topbar">
    <div class="tab active" id="homeTab">Home</div>
    <div class="tab" id="analysisTab">Analysis</div>
    <div class="tab" id="objectsTab">Objects</div>
    <div class="tab" id="viewTab">View</div>
    <div class="tab" id="settingsTab">Settings</div>
    <div class="tab" id="managementTab">Management</div>
  </div>

  <!-- Sub-menu for Home tab -->
  <div id="homeSubmenu" class="submenu-panel show">
    <div class="subtab" id="selectTool"><i class="fas fa-mouse-pointer"></i> Select Tool</div>
    <div class="subtab" data-type="feature"><i class="fas fa-layer-group"></i> Add Feature Layer</div>
    <div class="subtab" data-type="raster"><i class="fas fa-image"></i> Add Raster Layer</div>
    <div class="subtab" data-type="object"><i class="fas fa-crosshairs"></i> Object Layer</div>
  </div>

  <!-- Sub-menu for Analysis tab -->
  <div id="submenu" class="submenu-panel">
    <div class="subtab" id="vectorBtn"><i class="fas fa-vector-square"></i> Vector</div>
    <div class="subtab" id="rasterBtn"><i class="fas fa-image"></i> Raster</div>
  </div>

  <!-- Sub-menu for Objects tab -->
  <div id="objectsSubmenu" class="submenu-panel">
    <div class="subtab" data-type="Point"><i class="fas fa-map-marker-alt"></i> Point</div>
    <div class="subtab" data-type="LineString"><i class="fas fa-route"></i> Line</div>
    <div class="subtab" data-type="Polygon"><i class="fas fa-draw-polygon"></i> Polygon</div>
  </div>

  <!-- Sub-menu for View tab -->
  <div id="viewSubmenu" class="submenu-panel">
    <div class="subtab" id="dualMapToggle"><i class="fas fa-columns"></i> Dual Map View</div>
    <div class="subtab" id="baseLayerBtn"><i class="fas fa-globe"></i> Map Base Layer</div>
    <div class="subtab" id="themeToggle"><i class="fas fa-moon"></i> Dark Mode</div>
  </div>

  <!-- Sub-menu for Settings tab -->
  <div id="settingsSubmenu" class="submenu-panel">
    <div class="panel left-panel">
      <label><input type="checkbox" id="layerPanelToggle" checked> Project Tree</label>
    </div>
    <div class="divider"></div>
    <div class="panel right-panel">
      <label>L/L Coordinates:
        <select id="coordFormat">
          <option value="DD" selected>Decimal Degrees</option>
          <option value="DMS">Degrees, Minutes, Seconds</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Popups -->
  <div id="vectorPopup" class="feature-popup" style="display:none; left:40%; top:30%;">
    <span class="close-btn" onclick="this.parentElement.style.display='none'">√ó</span>
    <h4>Add Vector Data</h4>
    <input type="file" id="vectorFile" accept=".kml,.kmz,.geojson,.json"><br><br>
    <button id="loadVectorBtn">Load Vector</button>
  </div>
  <div id="wfsPopup" class="feature-popup" style="display:none; left:40%; top:30%;">
    <span class="close-btn" onclick="this.parentElement.style.display='none'">√ó</span>
    <h4>Open WFS Layer</h4>
    <label>WFS URL:</label>
    <input type="text" id="wfsUrl" placeholder="https://example.com/geoserver/wfs">
    <label>Feature Type:</label>
    <input type="text" id="wfsTypeName" placeholder="namespace:layer">
    <button id="loadWfsBtn">Load WFS</button>
  </div>
  <div id="imageryPopup" class="feature-popup" style="display:none; left:40%; top:30%;">
    <span class="close-btn" onclick="this.parentElement.style.display='none'">√ó</span>
    <h4>Add Local Imagery</h4>
    <input type="file" id="imageryFile" accept=".tif,.tiff,.jpg,.jpeg,.png"><br><br>
    <button id="loadImageryBtn">Load Imagery</button>
  </div>
  <div id="wmsPopup" class="feature-popup" style="display:none; left:40%; top:30%;">
    <span class="close-btn" onclick="this.parentElement.style.display='none'">√ó</span>
    <h4>Add WMS Layer</h4>
    <label>WMS URL:</label>
    <input type="text" id="wmsUrl" placeholder="https://example.com/geoserver/wms">
    <label>Layer Name:</label>
    <input type="text" id="wmsLayer" placeholder="layer:namespace">
    <button id="loadWmsBtn">Load WMS</button>
  </div>

  <!-- Base layer popups -->
  <div id="baseLayerPopupLeft" style="display:none;">
    <select id="baseLayerSelectLeft">
      <option value="OpenStreetMap">OpenStreetMap</option>
      <option value="USGS Imagery Only">USGS Imagery Only</option>
      <option value="Local Imagery">Local Imagery</option>
    </select>
  </div>
  <div id="baseLayerPopupRight" style="display:none;">
    <select id="baseLayerSelectRight">
      <option value="OpenStreetMap">OpenStreetMap</option>
      <option value="USGS Imagery Only">USGS Imagery Only</option>
      <option value="Local Imagery">Local Imagery</option>
    </select>
  </div>

  <!-- Layer panel -->
  <div id="layerPanel">
    <div class="panel-header">
      <h3>Project Tree</h3>
      <span class="close-btn" id="closePanel">√ó</span>
    </div>
    <div class="search-container">
      <input type="text" class="search-bar" id="layerSearch" placeholder="Search places">
      <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
      <div id="searchResults"></div>
    </div>
    <div class="layer-list" id="layerList"></div>
    <div class="layer-footer">
      ¬© 2025. Developed by <a href="https://projectmaps9-prog.github.io/Bikramjit-Singh/" target="_blank">Bikramjit Singh</a>.
    </div>
  </div>

  <!-- Audit Trail Popup -->
  <div id="auditPopup">
    <div class="popup-header">
      <h3>Audit Trail</h3>
      <span class="close-btn" id="closeAuditPopup">√ó</span>
    </div>
    <div class="log-list" id="logList"></div>
    <div class="layer-footer">
      Last updated: <span id="lastUpdate">--</span>
      <button id="exportAuditBtn"><i class="fas fa-file-pdf"></i> Export PDF</button>
    </div>
  </div>

  <!-- Context menu -->
  <div id="contextMenu" class="context-menu">
    <div class="menu-item" id="createGroup"><i class="fas fa-folder"></i> Create Group</div>
    <div class="menu-item" id="refreshLayers"><i class="fas fa-sync-alt"></i> Refresh</div>
  </div>

  <!-- Map container -->
  <div id="map-container">
    <div id="map-left" class="ol-mode"></div>
    <div id="map-right" class="ol-mode"></div>
  </div>

  <!-- North button -->
  <div class="ol-north" id="northBtn"><i class="fa-solid fa-arrow-up"></i>
</div>

  <!-- Status bar -->
  <div id="statusbar">
    <div id="coords">Lat: -- , Lon: -- , Zoom: --</div>
    <div id="goto">
      Lat: <input type="text" id="latInput" placeholder="e.g. 28.6">
      Lon: <input type="text" id="lonInput" placeholder="e.g. 77.2">
      <button id="goBtn"><i class="fas fa-location-crosshairs"></i> Go</button>
    </div>
    <div id="epsgContainer">
      <span id="epsgLabel" style="cursor:pointer; font-weight:bold; color:var(--link-color);">
        üåê EPSG: 3857
      </span>
      <input type="text" id="epsgInput" placeholder="Enter EPSG" style="display:none;">
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Base layers
    const osmLayerLeft = new ol.layer.Tile({ source: new ol.source.OSM(), properties: { name: 'OpenStreetMap' } });
    const usgsImageryOnlyLayerLeft = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        attributions: 'Esri, Maxar, Earthstar Geographics'
      }),
      properties: { name: 'USGS Imagery Only' }
    });
    const osmLayerRight = new ol.layer.Tile({ source: new ol.source.OSM(), properties: { name: 'OpenStreetMap' } });
    const usgsImageryOnlyLayerRight = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        attributions: 'Esri, Maxar, Earthstar Geographics'
      }),
      properties: { name: 'USGS Imagery Only' }
    });
    const allBaseLayersLeft = [osmLayerLeft, usgsImageryOnlyLayerLeft];
    const allBaseLayersRight = [osmLayerRight, usgsImageryOnlyLayerRight];

    // Shared layers
    const vectorSource = new ol.source.Vector();
    const vectorLayer = new ol.layer.Vector({ source: vectorSource });
    const markerSource = new ol.source.Vector();
    const markerLayer = new ol.layer.Vector({ source: markerSource });

    // Audit Log
    const auditLog = [];
    function addToAudit(action, type, name, details = '') {
      const entry = {
        timestamp: new Date().toLocaleString(),
        action,
        type,
        name,
        details
      };
      auditLog.push(entry);
      updateAuditPopup();
      document.getElementById("lastUpdate").textContent = entry.timestamp;
    }
    function updateAuditPopup() {
      const logList = document.getElementById("logList");
      logList.innerHTML = auditLog.map(log => 
        `<div class="log-item">[${log.timestamp}] ${log.action} ${log.type}: ${log.name}${log.details ? ' - ' + log.details : ''}</div>`
      ).join('');
    }
    function exportAuditToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text('Audit Trail Report', 10, 10);
      let y = 20;
      auditLog.forEach(log => {
        const text = `[${log.timestamp}] ${log.action} ${log.type}: ${log.name}${log.details ? ' - ' + log.details : ''}`;
        if (y > 280) {
          doc.addPage();
          y = 10;
        }
        doc.text(text, 10, y);
        y += 10;
      });
      doc.save('audit-trail.pdf');
      addToAudit('Exported', 'Audit Report', 'PDF');
    }

    // Map initialization
    let isDualMap = false;
    const mapLeft = new ol.Map({
      target: null,
      layers: [osmLayerLeft, vectorLayer, markerLayer],
      view: new ol.View({
        center: ol.proj.fromLonLat([78.9629, 20.5937]),
        zoom: 5
      })
    });
    const mapRight = new ol.Map({
      target: 'map-right',
      layers: [usgsImageryOnlyLayerRight, vectorLayer, markerLayer],
      view: new ol.View({
        center: ol.proj.fromLonLat([78.9629, 20.5937]),
        zoom: 5
      })
    });

    // Map Synchronization
    let syncTimeout;
    function syncMaps() {
      if (!isDualMap) return;
      const viewLeft = mapLeft.getView();
      const viewRight = mapRight.getView();
      const updateRightView = () => {
        clearTimeout(syncTimeout);
        syncTimeout = setTimeout(() => {
          viewRight.setCenter(viewLeft.getCenter());
          viewRight.setResolution(viewLeft.getResolution());
          viewRight.setRotation(viewLeft.getRotation());
          mapRight.updateSize();
        }, 50);
      };
      viewLeft.on('change:center', updateRightView);
      viewLeft.on('change:resolution', updateRightView);
      viewLeft.on('change:rotation', updateRightView);
    }

    // Dual Map Toggle
    function toggleDualMap() {
      isDualMap = !isDualMap;
      const mapContainer = document.getElementById('map-container');
      const mapLeftDiv = document.getElementById('map-left');
      const mapRightDiv = document.getElementById('map-right');
      const dualMapToggle = document.getElementById('dualMapToggle');
      const baseLayerPopupLeft = document.getElementById('baseLayerPopupLeft');
      const baseLayerPopupRight = document.getElementById('baseLayerPopupRight');
      if (isDualMap) {
        mapContainer.classList.add('dual-map');
        mapLeftDiv.style.display = 'block';
        mapRightDiv.style.width = '50%';
        mapLeft.setTarget('map-left');
        baseLayerPopupLeft.style.display = 'block';
        baseLayerPopupRight.style.display = 'block';
        syncMaps();
        dualMapToggle.innerHTML = '<i class="fas fa-columns"></i> Single Map View';
        addToAudit('Toggled', 'Map View', 'Dual Map', 'Activated');
      } else {
        mapContainer.classList.remove('dual-map');
        mapLeftDiv.style.display = 'none';
        mapRightDiv.style.width = '100%';
        mapLeft.setTarget(null);
        baseLayerPopupLeft.style.display = 'none';
        baseLayerPopupRight.style.display = 'none';
        dualMapToggle.innerHTML = '<i class="fas fa-columns"></i> Dual Map View';
        addToAudit('Toggled', 'Map View', 'Single Map', 'Activated');
      }
      mapRight.updateSize();
      if (isDualMap) mapLeft.updateSize();
    }

    // Base layer switching
    function switchBaseLayer(map, layerName, allBaseLayers, side) {
      if (layerName === 'Local Imagery') {
        document.getElementById('imageryPopup').style.display = 'block';
        document.getElementById('imageryPopup').dataset.side = side;
        return;
      }
      const currentBaseLayer = map.getLayers().getArray()[0];
      if (currentBaseLayer.get('name') !== layerName) {
        map.getLayers().forEach(layer => {
          if (allBaseLayers.includes(layer)) map.removeLayer(layer);
        });
        const selectedLayer = allBaseLayers.find(layer => layer.get('name') === layerName);
        map.getLayers().insertAt(0, selectedLayer);
        addToAudit('Changed', 'Base Layer', selectedLayer.get('name'), `on ${side} map`);
      }
    }

    // Theme Toggle
    let isDark = false;
    document.getElementById('themeToggle').addEventListener('click', () => {
      isDark = !isDark;
      document.documentElement.classList.toggle('dark-theme', isDark);
      const icon = isDark ? 'fas fa-sun' : 'fas fa-moon';
      const text = isDark ? 'Light Mode' : 'Dark Mode';
      document.getElementById('themeToggle').innerHTML = `<i class="${icon}"></i> ${text}`;
      addToAudit('Toggled', 'Theme', isDark ? 'Dark' : 'Light');
    });

    // Toolbar and submenu logic
    const tabs = document.querySelectorAll("#topbar .tab");
    const homeSubmenu = document.getElementById("homeSubmenu");
    const submenu = document.getElementById("submenu");
    const objectsSubmenu = document.getElementById("objectsSubmenu");
    const viewSubmenu = document.getElementById("viewSubmenu");
    const settingsSubmenu = document.getElementById("settingsSubmenu");
    const auditPopup = document.getElementById("auditPopup");
    let drawInteraction;

    // Analysis submenu layouts
    const originalSubmenuHTML = submenu.innerHTML;
    function resetSubmenu() {
      submenu.innerHTML = originalSubmenuHTML;
      document.getElementById('vectorBtn').addEventListener('click', showVectorLayout);
      document.getElementById('rasterBtn').addEventListener('click', showRasterLayout);
    }
    function showVectorLayout() {
      submenu.innerHTML = `
        <div class="subtab" id="backBtn"><i class="fas fa-arrow-left"></i> Back</div>
        <div class="subtab" data-tool="areaCalc"><i class="fas fa-ruler-combined"></i> Area Calculation</div>
        <div class="subtab" data-tool="measurement"><i class="fas fa-ruler-horizontal"></i> Measurement</div>
        <div class="subtab" data-tool="buffer"><i class="fas fa-shield-alt"></i> Buffer Tools</div>
        <div class="subtab" data-tool="clip"><i class="fas fa-cut"></i> Clip</div>
        <div class="subtab" data-tool="intersect"><i class="fas fa-object-group"></i> Intersect</div>
        <div class="subtab" data-tool="dissolve"><i class="fas fa-compress-arrows-alt"></i> Dissolve</div>
        <div class="subtab" data-tool="union"><i class="fas fa-object-ungroup"></i> Union</div>
        <div class="subtab" data-tool="spatialJoin"><i class="fas fa-link"></i> Spatial Join</div>
      `;
      document.getElementById('backBtn').addEventListener('click', resetSubmenu);
      submenu.querySelectorAll('.subtab[data-tool]').forEach(subtab => {
        subtab.addEventListener('click', () => alert(`Clicked "${subtab.textContent.trim()}" Vector tool!`));
      });
    }
    function showRasterLayout() {
      submenu.innerHTML = `
        <div class="subtab" id="backBtn"><i class="fas fa-arrow-left"></i> Back</div>
        <div class="subtab" data-tool="heatmap"><i class="fas fa-chart-line"></i> Heatmap</div>
        <div class="subtab" data-tool="rasterCalc"><i class="fas fa-calculator"></i> Raster Calculations</div>
        <div class="subtab" data-tool="terrain"><i class="fas fa-mountain"></i> Terrain Analysis</div>
      `;
      document.getElementById('backBtn').addEventListener('click', resetSubmenu);
      submenu.querySelectorAll('.subtab[data-tool]').forEach(subtab => {
        subtab.addEventListener('click', () => alert(`Clicked "${subtab.textContent.trim()}" Raster tool!`));
      });
    }

    document.getElementById('dualMapToggle').addEventListener('click', toggleDualMap);
    document.getElementById('closeAuditPopup').addEventListener("click", () => {
      auditPopup.style.display = "none";
    });
    document.getElementById('exportAuditBtn').addEventListener('click', exportAuditToPDF);

    // Base layer dropdown in View tab
    const baseLayerButton = document.getElementById("baseLayerBtn");
    const baseLayerDropdown = document.createElement("div");
    baseLayerDropdown.id = "baseLayerDropdown";
    baseLayerDropdown.style.position = "absolute";
    baseLayerDropdown.style.display = "none";
    baseLayerDropdown.style.flexDirection = "column";
    baseLayerDropdown.style.zIndex = "2000";
    baseLayerDropdown.style.borderRadius = "6px";
    baseLayerDropdown.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
    baseLayerDropdown.innerHTML = `
      <div class="subtab" data-layer="OpenStreetMap">OpenStreetMap</div>
      <div class="subtab" data-layer="USGS Imagery Only">USGS Imagery Only</div>
    `;
    document.body.appendChild(baseLayerDropdown);
    baseLayerButton.addEventListener("click", (e) => {
      e.stopPropagation();
      const rect = baseLayerButton.getBoundingClientRect();
      baseLayerDropdown.style.left = `${rect.left}px`;
      baseLayerDropdown.style.top = `${rect.bottom}px`;
      baseLayerDropdown.style.width = `${rect.width}px`;
      baseLayerDropdown.style.display = baseLayerDropdown.style.display === "flex" ? "none" : "flex";
    });
    baseLayerDropdown.addEventListener("click", (e) => {
      const layerName = e.target.dataset.layer;
      if (layerName) {
        switchBaseLayer(mapRight, layerName, allBaseLayersRight, 'right');
        if (isDualMap) switchBaseLayer(mapLeft, layerName, allBaseLayersLeft, 'left');
        baseLayerDropdown.style.display = "none";
      }
    });

    // Base layer popups for dual map mode
    document.getElementById('baseLayerSelectLeft').addEventListener('change', (e) => {
      switchBaseLayer(mapLeft, e.target.value, allBaseLayersLeft, 'left');
    });
    document.getElementById('baseLayerSelectRight').addEventListener('change', (e) => {
      switchBaseLayer(mapRight, e.target.value, allBaseLayersRight, 'right');
    });

    // Initialize analysis buttons
    document.getElementById('vectorBtn').addEventListener('click', showVectorLayout);
    document.getElementById('rasterBtn').addEventListener('click', showRasterLayout);

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        homeSubmenu.classList.remove("show");
        submenu.classList.remove("show");
        objectsSubmenu.classList.remove("show");
        viewSubmenu.classList.remove("show");
        settingsSubmenu.classList.remove("show");
        featureDropdown.style.display = "none";
        rasterDropdown.style.display = "none";
        objectDropdown.style.display = "none";
        baseLayerDropdown.style.display = "none";
        auditPopup.style.display = "none";
        if (drawInteraction) {
          mapLeft.removeInteraction(drawInteraction);
          if (isDualMap) mapRight.removeInteraction(drawInteraction);
        }
        if (tab.id === "homeTab") homeSubmenu.classList.add("show");
        else if (tab.id === "analysisTab") {
          submenu.classList.add("show");
          resetSubmenu();
        }
        else if (tab.id === "objectsTab") objectsSubmenu.classList.add("show");
        else if (tab.id === "viewTab") viewSubmenu.classList.add("show");
        else if (tab.id === "settingsTab") settingsSubmenu.classList.add("show");
        else if (tab.id === "managementTab") auditPopup.style.display = "block";
      });
    });

    // Objects submenu event listeners
    document.querySelectorAll("#objectsSubmenu .subtab").forEach(subtab => {
      subtab.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const type = subtab.dataset.type;
        setupDraw(type);
        // Keep Objects tab and submenu open
        // Ensure other submenus are closed
        submenu.classList.remove("show");
        homeSubmenu.classList.remove("show");
        viewSubmenu.classList.remove("show");
        settingsSubmenu.classList.remove("show");
      });
    });

    // Coordinate formatting
    function toDMS(coord, isLat) {
      const abs = Math.abs(coord);
      const deg = Math.floor(abs);
      const minNotTrunc = (abs - deg) * 60;
      const min = Math.floor(minNotTrunc);
      const sec = ((minNotTrunc - min) * 60).toFixed(2);
      const dir = isLat ? (coord >= 0 ? 'N' : 'S') : (coord >= 0 ? 'E' : 'W');
      return `${deg}¬∞ ${min}' ${sec}" ${dir}`;
    }
    function formatCoordinates(lon, lat, format) {
      return format === "DMS" ? { lat: toDMS(lat, true), lon: toDMS(lon, false) } : { lat: lat.toFixed(4), lon: lon.toFixed(4) };
    }
    const coordsDisplay = document.getElementById("coords");
    const coordFormatSelect = document.getElementById("coordFormat");
    let coordFormat = coordFormatSelect.value;
    function updateStatus() {
      const view = mapRight.getView();
      let center = view.getCenter();
      let coords;
      try {
        const lonLat = ol.proj.toLonLat(center, view.getProjection());
        coords = formatCoordinates(lonLat[0], lonLat[1], coordFormat);
      } catch(e) {
        coords = { lat: center[1].toFixed(4), lon: center[0].toFixed(4) };
      }
      coordsDisplay.innerHTML = `Lat: ${coords.lat}, Lon: ${coords.lon}, Zoom: ${view.getZoom().toFixed(0)}`;
    }
    coordFormatSelect.addEventListener("change", () => { coordFormat = coordFormatSelect.value; updateStatus(); });
    mapRight.getView().on("change:center", updateStatus);
    mapRight.getView().on("change:resolution", updateStatus);
    updateStatus();

    // Go button
    function addMarker(lon, lat) {
      markerSource.clear();
      const feature = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])) });
      const style = new ol.style.Style({ image: new ol.style.Icon({ src: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', anchor: [0.5,1], scale: 0.1 }) });
      feature.setStyle(style);
      markerSource.addFeature(feature);
      let scale = 0.1;
      const interval = setInterval(() => { scale += 0.05; style.getImage().setScale(scale); markerSource.changed(); if (scale >= 0.25) clearInterval(interval); }, 50);
    }
    document.getElementById("goBtn").addEventListener("click", () => {
      const lat = parseFloat(document.getElementById("latInput").value);
      const lon = parseFloat(document.getElementById("lonInput").value);
      if (!isNaN(lat) && !isNaN(lon)) {
        mapRight.getView().animate({ center: ol.proj.fromLonLat([lon, lat]), zoom: 10, duration: 1000 });
        if (isDualMap) mapLeft.getView().animate({ center: ol.proj.fromLonLat([lon, lat]), zoom: 10, duration: 1000 });
        addMarker(lon, lat);
      } else alert("Enter valid latitude and longitude!");
    });

    // North button
    const northBtn = document.getElementById("northBtn");
    mapRight.getView().on('change:rotation', () => { northBtn.style.transform = `rotate(${-mapRight.getView().getRotation()}rad)`; });
    northBtn.addEventListener("click", () => {
      mapRight.getView().animate({ rotation: 0, duration: 500 });
      if (isDualMap) mapLeft.getView().animate({ rotation: 0, duration: 500 });
    });

    // Draw objects
    function onDrawEnd(feature, geometryType) {
      const existingPopup = document.querySelector('.feature-popup');
      if (existingPopup) existingPopup.remove();
      const popup = document.createElement('div');
      popup.className = 'feature-popup';
      popup.style.left = `${mapRight.getSize()[0] / (isDualMap ? 4 : 2)}px`;
      popup.style.top = `${mapRight.getSize()[1] / 2}px`;
      popup.innerHTML = `
        <span class="close-btn" onclick="this.parentElement.remove(); document.querySelector('.ol-draw').click()">√ó</span>
        <label>Name:</label>
        <input type="text" id="featureName" placeholder="Enter feature name">
        <label>Color:</label>
        <input type="color" id="featureColor" value="#FF0000">
        ${geometryType === 'Point' ? `
          <label>Scale:</label>
          <input type="number" id="featureScale" value="1" min="0.1" max="5" step="0.1">
        ` : `
          <label>Line Width:</label>
          <input type="number" id="featureLineWidth" value="2" min="1" max="10" step="1">
        `}
        <button id="saveFeature">OK</button>
      `;
      document.body.appendChild(popup);
      document.getElementById('saveFeature').addEventListener('click', () => {
        const name = document.getElementById('featureName').value.trim() || `Object-${vectorSource.getFeatures().length}`;
        const color = document.getElementById('featureColor').value;
        const scale = geometryType === 'Point' ? parseFloat(document.getElementById('featureScale').value) : null;
        const lineWidth = geometryType !== 'Point' ? parseInt(document.getElementById('featureLineWidth').value) : null;
        feature.set('name', name);
        feature.set('color', color);
        if (geometryType === 'Point') {
          feature.set('scale', scale);
          feature.setStyle(new ol.style.Style({
            image: new ol.style.Circle({
              radius: 5 * scale,
              fill: new ol.style.Fill({ color: color }),
              stroke: new ol.style.Stroke({ color: '#000000', width: 1 })
            })
          }));
        } else {
          feature.set('lineWidth', lineWidth);
          feature.setStyle(new ol.style.Style({
            stroke: new ol.style.Stroke({ color: color, width: lineWidth }),
            fill: geometryType === 'Polygon' ? new ol.style.Fill({ color: `${color}80` }) : null
          }));
        }
        const layerList = document.getElementById("layerList");
        const objItem = document.createElement("div");
        objItem.className = "layer-item";
        objItem.innerHTML = `
          <input type="checkbox" checked data-feature-id="${feature.getId() || vectorSource.getFeatures().length}">
          <label>${name} (${geometryType})</label>
        `;
        layerList.appendChild(objItem);
        objItem.querySelector('input').addEventListener('change', (e) => {
          feature.setStyle(e.target.checked ? null : new ol.style.Style({}));
        });
        addToAudit('Added', geometryType, name);
        popup.remove();
        mapRight.removeInteraction(drawInteraction);
        if (isDualMap) mapLeft.removeInteraction(drawInteraction);
      });
    }
    function setupDraw(type) {
      if (drawInteraction) {
        mapRight.removeInteraction(drawInteraction);
        if (isDualMap) mapLeft.removeInteraction(drawInteraction);
      }
      drawInteraction = new ol.interaction.Draw({ source: vectorSource, type: type });
      mapRight.addInteraction(drawInteraction);
      if (isDualMap) mapLeft.addInteraction(drawInteraction);
      drawInteraction.on('drawend', (event) => onDrawEnd(event.feature, type));
    }

    // Attribute popup on click
    function addClickListener(map, mapId) {
      map.on('click', event => {
        if (!drawInteraction) {
          const coord = ol.proj.toLonLat(event.coordinate);
          const coords = formatCoordinates(coord[0], coord[1], coordFormat);
          const existingPopup = document.querySelector(`.attribute-table[data-map="${mapId}"]`);
          if (existingPopup) existingPopup.remove();
          const popup = document.createElement('div');
          popup.className = 'attribute-table';
          popup.dataset.map = mapId;
          const offsetX = isDualMap ? (mapId === 'left' ? event.pixel[0] + 10 : event.pixel[0] + mapRight.getSize()[0] / 2 + 10) : event.pixel[0] + 10;
          popup.style.left = `${offsetX}px`;
          popup.style.top = `${event.pixel[1] + 10}px`;
          popup.innerHTML = `<table>
            <tr><td>Latitude</td><td>${coords.lat}</td></tr>
            <tr><td>Longitude</td><td>${coords.lon}</td></tr>
          </table>
          <span class="close-btn" onclick="this.parentElement.remove()">√ó</span>`;
          document.body.appendChild(popup);
        }
      });
    }
    addClickListener(mapRight, 'right');
    addClickListener(mapLeft, 'left');

    // Search functionality
    let searchTimeout;
    let currentQuery = '';
    const searchInput = document.getElementById("layerSearch");
    const searchBtn = document.getElementById("searchBtn");
    const searchResults = document.getElementById("searchResults");
    const layerList = document.getElementById("layerList");
    async function fetchSearchResults(query) {
      if (!query.trim()) {
        searchResults.style.display = "none";
        return;
      }
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`, {
          headers: { 'User-Agent': 'WebGISPortal/1.0' }
        });
        const results = await response.json();
        if (results.length === 0) {
          searchResults.innerHTML = "<div class='result-item'>No results found</div>";
        } else {
          searchResults.innerHTML = results.map(result => `
            <div class="result-item" data-lat="${result.lat}" data-lon="${result.lon}" data-display="${result.display_name}">
              ${result.display_name}
            </div>
          `).join('');
        }
        searchResults.style.display = "block";
      } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = "<div class='result-item'>Search error</div>";
        searchResults.style.display = "block";
      }
    }
    searchInput.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      currentQuery = searchInput.value;
      searchTimeout = setTimeout(() => {
        fetchSearchResults(searchInput.value);
      }, 300);
    });
    searchBtn.addEventListener("click", () => {
      currentQuery = searchInput.value.trim();
      fetchSearchResults(currentQuery);
    });
    searchInput.addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        currentQuery = searchInput.value.trim();
        fetchSearchResults(currentQuery);
      }
    });
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('result-item') && !e.target.textContent.startsWith('No') && !e.target.textContent.startsWith('Search')) {
        const lat = parseFloat(e.target.dataset.lat);
        const lon = parseFloat(e.target.dataset.lon);
        const displayName = e.target.dataset.display;
        let group = Array.from(layerList.querySelectorAll('.layer-group h4')).find(h4 => h4.textContent.includes(currentQuery));
        let count = 1;
        if (group) {
          const match = group.textContent.match(/\((\d+)\)/);
          count = (match ? parseInt(match[1]) : 0) + 1;
          group.textContent = `Search: ${currentQuery} (${count})`;
        } else {
          const newGroup = document.createElement('div');
          newGroup.className = 'layer-group';
          newGroup.innerHTML = `<h4>Search: ${currentQuery} (1)</h4>`;
          layerList.appendChild(newGroup);
          group = newGroup.querySelector('h4');
        }
        let searchSource, searchLayer;
        if (!group.dataset.sourceId) {
          searchSource = new ol.source.Vector();
          searchLayer = new ol.layer.Vector({
            source: searchSource,
            properties: { name: `Search: ${currentQuery}` }
          });
          mapRight.addLayer(searchLayer);
          if (isDualMap) mapLeft.addLayer(searchLayer);
          group.dataset.sourceId = `search-${currentQuery.replace(/\s+/g, '-')}`;
        } else {
          searchLayer = mapRight.getLayers().getArray().find(l => l.get('name') === `Search: ${currentQuery}`);
          searchSource = searchLayer.getSource();
        }
        const style = new ol.style.Style({
          image: new ol.style.Icon({
            src: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
            anchor: [0.5, 1],
            scale: 0.1
          })
        });
        const coord = ol.proj.fromLonLat([lon, lat]);
        const feature = new ol.Feature({
          geometry: new ol.geom.Point(coord),
          name: displayName
        });
        feature.setStyle(style);
        searchSource.addFeature(feature);
        const item = document.createElement("div");
        item.className = "layer-item";
        item.innerHTML = `
          <input type="checkbox" checked>
          <label>${displayName}</label>
        `;
        const groupDiv = group.parentNode;
        groupDiv.appendChild(item);
        const checkbox = item.querySelector('input');
        checkbox.addEventListener('change', (e) => {
          feature.setStyle(e.target.checked ? style : new ol.style.Style({}));
        });
        mapRight.getView().animate({
          center: coord,
          zoom: 15,
          duration: 1000
        });
        if (isDualMap) mapLeft.getView().animate({
          center: coord,
          zoom: 15,
          duration: 1000
        });
        addToAudit('Added', 'Search Location', displayName, `from query: ${currentQuery}`);
        searchInput.value = "";
        searchResults.style.display = "none";
      }
      const searchContainer = document.querySelector('.search-container');
      if (!searchContainer.contains(e.target) && searchResults.style.display === "block") {
        searchResults.style.display = "none";
      }
    });

    // Layer panel toggle
    const layerPanel = document.getElementById("layerPanel");
    const closePanelBtn = document.getElementById("closePanel");
    closePanelBtn.addEventListener("click", () => { layerPanel.classList.add("collapsed"); document.getElementById("layerPanelToggle").checked=false; });
    document.getElementById("layerPanelToggle").addEventListener("change", () => {
      if(document.getElementById("layerPanelToggle").checked) layerPanel.classList.remove("collapsed");
      else layerPanel.classList.add("collapsed");
    });

    // Feature dropdown
    const featureButton = document.querySelector('#homeSubmenu .subtab[data-type="feature"]');
    const featureDropdown = document.createElement("div");
    featureDropdown.id = "featureDropdown";
    featureDropdown.style.position = "absolute";
    featureDropdown.style.display = "none";
    featureDropdown.style.flexDirection = "column";
    featureDropdown.style.zIndex = "2000";
    featureDropdown.style.borderRadius = "6px";
    featureDropdown.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
    featureDropdown.innerHTML = `
      <div class="subtab" data-action="vector"><i class="fas fa-file-import"></i> Add Vector Data</div>
      <div class="subtab" data-action="wfs"><i class="fas fa-globe-americas"></i> Open WFS</div>
    `;
    document.body.appendChild(featureDropdown);
    featureButton.addEventListener("click", (e) => {
      e.stopPropagation();
      // Close other dropdowns
      rasterDropdown.style.display = "none";
      objectDropdown.style.display = "none";
      const rect = featureButton.getBoundingClientRect();
      featureDropdown.style.left = `${rect.left}px`;
      featureDropdown.style.top = `${rect.bottom}px`;
      featureDropdown.style.width = `${rect.width}px`;
      featureDropdown.style.display = featureDropdown.style.display === "flex" ? "none" : "flex";
    });
    featureDropdown.addEventListener("click", (e) => {
      const action = e.target.dataset.action;
      if (action === "vector") document.getElementById("vectorPopup").style.display = "block";
      else if (action === "wfs") document.getElementById("wfsPopup").style.display = "block";
      featureDropdown.style.display = "none";
      e.stopPropagation();
    });

    // Raster dropdown
    const rasterButton = document.querySelector('#homeSubmenu .subtab[data-type="raster"]');
    const rasterDropdown = document.createElement("div");
    rasterDropdown.id = "rasterDropdown";
    rasterDropdown.style.position = "absolute";
    rasterDropdown.style.display = "none";
    rasterDropdown.style.flexDirection = "column";
    rasterDropdown.style.zIndex = "2000";
    rasterDropdown.style.borderRadius = "6px";
    rasterDropdown.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
    rasterDropdown.innerHTML = `
      <div class="subtab" data-action="imagery"><i class="fas fa-image"></i> Add Imagery</div>
      <div class="subtab" data-action="wms"><i class="fas fa-globe"></i> Open WMS</div>
    `;
    document.body.appendChild(rasterDropdown);
    rasterButton.addEventListener("click", (e) => {
      e.stopPropagation();
      // Close other dropdowns
      featureDropdown.style.display = "none";
      objectDropdown.style.display = "none";
      const rect = rasterButton.getBoundingClientRect();
      rasterDropdown.style.left = `${rect.left}px`;
      rasterDropdown.style.top = `${rect.bottom}px`;
      rasterDropdown.style.width = `${rect.width}px`;
      rasterDropdown.style.display = rasterDropdown.style.display === "flex" ? "none" : "flex";
    });
    rasterDropdown.addEventListener("click", (e) => {
      if (e.target.dataset.action === "imagery") document.getElementById("imageryPopup").style.display = "block";
      else if (e.target.dataset.action === "wms") document.getElementById("wmsPopup").style.display = "block";
      rasterDropdown.style.display = "none";
      e.stopPropagation();
    });

    // Object dropdown
    const objectButton = document.querySelector('#homeSubmenu .subtab[data-type="object"]');
    const objectDropdown = document.createElement("div");
    objectDropdown.id = "objectDropdown";
    objectDropdown.style.position = "absolute";
    objectDropdown.style.display = "none";
    objectDropdown.style.flexDirection = "column";
    objectDropdown.style.zIndex = "2000";
    objectDropdown.style.borderRadius = "6px";
    objectDropdown.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
    objectDropdown.innerHTML = `
      <div class="subtab" data-type="Point"><i class="fas fa-map-marker-alt"></i> Point</div>
      <div class="subtab" data-type="LineString"><i class="fas fa-route"></i> Line</div>
      <div class="subtab" data-type="Polygon"><i class="fas fa-draw-polygon"></i> Polygon</div>
    `;
    document.body.appendChild(objectDropdown);
    objectButton.addEventListener("click", (e) => {
      e.stopPropagation();
      // Close other dropdowns
      featureDropdown.style.display = "none";
      rasterDropdown.style.display = "none";
      const rect = objectButton.getBoundingClientRect();
      objectDropdown.style.left = `${rect.left}px`;
      objectDropdown.style.top = `${rect.bottom}px`;
      objectDropdown.style.width = `${rect.width}px`;
      objectDropdown.style.display = objectDropdown.style.display === "flex" ? "none" : "flex";
    });
    objectDropdown.addEventListener("click", (e) => {
      const subtab = e.target.closest('.subtab');
      if (subtab) {
        const type = subtab.getAttribute("data-type");
        setupDraw(type);
        objectDropdown.style.display = "none";
        e.stopPropagation();
      }
    });

    // Close dropdowns
    document.addEventListener("click", () => {
      featureDropdown.style.display = "none";
      rasterDropdown.style.display = "none";
      objectDropdown.style.display = "none";
      baseLayerDropdown.style.display = "none";
    });

    // Context menu
    const contextMenu = document.getElementById('contextMenu');
    layerList.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      contextMenu.style.left = `${e.pageX}px`;
      contextMenu.style.top = `${e.pageY}px`;
      contextMenu.style.display = 'flex';
    });
    document.addEventListener('click', () => {
      contextMenu.style.display = 'none';
    });
    document.getElementById('createGroup').addEventListener('click', () => {
      const name = prompt('Enter group name:');
      if (name) {
        const group = document.createElement('div');
        group.className = 'layer-group';
        group.innerHTML = `<h4>${name}</h4>`;
        layerList.appendChild(group);
      }
      contextMenu.style.display = 'none';
    });
    document.getElementById('refreshLayers').addEventListener('click', () => {
      alert('Layers refreshed!');
      contextMenu.style.display = 'none';
    });

    // Load Vector Data
    document.getElementById("loadVectorBtn").addEventListener("click", () => {
      const fileInput = document.getElementById("vectorFile");
      if (fileInput.files.length === 0) {
        alert("Please select a vector file.");
        return;
      }
      const file = fileInput.files[0];
      const ext = file.name.split('.').pop().toLowerCase();
      let format;
      if (ext === 'kml' || ext === 'kmz') format = new ol.format.KML();
      else if (ext === 'geojson' || ext === 'json') format = new ol.format.GeoJSON();
      else {
        alert("Supported formats: KML/KMZ, GeoJSON/JSON.");
        return;
      }
      const vectorSource = new ol.source.Vector({
        url: URL.createObjectURL(file),
        format: format
      });
      const vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        properties: { name: `Vector - ${file.name}` }
      });
      mapRight.addLayer(vectorLayer);
      if (isDualMap) mapLeft.addLayer(vectorLayer);
      addLayerToPanel(vectorLayer);
      addToAudit('Added', 'Vector Layer', file.name);
      document.getElementById("vectorPopup").style.display = "none";
    });

    // Load WFS Layer
    document.getElementById("loadWfsBtn").addEventListener("click", () => {
      const url = document.getElementById("wfsUrl").value.trim();
      const typename = document.getElementById("wfsTypeName").value.trim();
      if (!url || !typename) {
        alert("Enter WFS URL and Feature Type!");
        return;
      }
      const wfsSource = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        url: function(extent) {
          return `${url}?service=WFS&version=1.1.0&request=GetFeature&typename=${typename}&outputFormat=application/json&srsname=EPSG:3857&bbox=${extent.join(',')},EPSG:3857`;
        },
        strategy: ol.loadingstrategy.bbox
      });
      const wfsLayer = new ol.layer.Vector({
        source: wfsSource,
        properties: { name: `WFS - ${typename}` }
      });
      mapRight.addLayer(wfsLayer);
      if (isDualMap) mapLeft.addLayer(wfsLayer);
      addLayerToPanel(wfsLayer);
      addToAudit('Added', 'WFS Layer', typename);
      document.getElementById("wfsPopup").style.display = "none";
    });

    // Load Local Imagery
    document.getElementById("loadImageryBtn").addEventListener("click", () => {
      const fileInput = document.getElementById("imageryFile");
      if (fileInput.files.length === 0) {
        alert("Please select an image file.");
        return;
      }
      const file = fileInput.files[0];
      const url = URL.createObjectURL(file);
      const imgExtent = [0, 0, 1024, 1024];
      const side = document.getElementById("imageryPopup").dataset.side || 'right';
      const map = side === 'left' ? mapLeft : mapRight;
      const allBaseLayers = side === 'left' ? allBaseLayersLeft : allBaseLayersRight;
      const rasterSource = new ol.source.ImageStatic({
        url: url,
        imageExtent: imgExtent
      });
      const rasterLayer = new ol.layer.Image({
        source: rasterSource,
        properties: { name: `Imagery - ${file.name}` }
      });
      map.getLayers().forEach(layer => {
        if (allBaseLayers.includes(layer)) map.removeLayer(layer);
      });
      map.getLayers().insertAt(0, rasterLayer);
      addLayerToPanel(rasterLayer);
      addToAudit('Added', 'Imagery Layer', file.name, `as base layer on ${side} map`);
      document.getElementById("imageryPopup").style.display = "none";
    });

    // Load WMS Layer
    document.getElementById("loadWmsBtn").addEventListener("click", () => {
      const url = document.getElementById("wmsUrl").value.trim();
      const layerName = document.getElementById("wmsLayer").value.trim();
      if (!url || !layerName) {
        alert("Enter WMS URL and Layer Name!");
        return;
      }
      const wmsLayer = new ol.layer.Tile({
        source: new ol.source.TileWMS({
          url: url,
          params: { LAYERS: layerName, TILED: true },
          serverType: 'geoserver',
          transition: 0
        }),
        properties: { name: `WMS - ${layerName}` }
      });
      mapRight.addLayer(wmsLayer);
      if (isDualMap) mapLeft.addLayer(wmsLayer);
      addLayerToPanel(wmsLayer);
      addToAudit('Added', 'WMS Layer', layerName);
      document.getElementById("wmsPopup").style.display = "none";
    });

    // Add layer to Layer Panel
    function addLayerToPanel(layer) {
      const layerList = document.getElementById("layerList");
      const name = layer.get('name') || `Layer-${layerList.children.length + 1}`;
      const item = document.createElement("div");
      item.className = "layer-item";
      item.innerHTML = `
        <input type="checkbox" checked>
        <label>${name}</label>
      `;
      layerList.appendChild(item);
      const checkbox = item.querySelector("input");
      checkbox.addEventListener("change", () => {
        layer.setVisible(checkbox.checked);
      });
    }

    // EPSG Switching
    const epsgLabel = document.getElementById("epsgLabel");
    const epsgInput = document.getElementById("epsgInput");
    epsgLabel.addEventListener("click", (e) => {
      e.stopPropagation();
      epsgInput.style.display = "block";
      epsgInput.focus();
    });
    epsgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const newEPSG = epsgInput.value.trim();
        if (newEPSG) {
          epsgLabel.textContent = `üåê EPSG: ${newEPSG}`;
          try {
            const proj = ol.proj.get(`EPSG:${newEPSG}`);
            if (proj) {
              mapRight.getView().setProjection(proj);
              if (isDualMap) mapLeft.getView().setProjection(proj);
              addToAudit('Changed', 'Projection', `EPSG:${newEPSG}`);
            } else {
              alert("Invalid EPSG code!");
            }
          } catch (e) {
            alert("Error setting projection!");
          }
        }
        epsgInput.style.display = "none";
      }
    });
    document.addEventListener('click', (e) => {
      if (epsgInput.style.display === 'block' && !epsgInput.contains(e.target) && !epsgLabel.contains(e.target)) {
        epsgInput.style.display = "none";
      }
    });
  </script>
</body>
</html>